<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <title>odapp-challenge</title>
</head>
<body>
    <header>
        <h1 >Gerencia de Paciente</h1>
    </header>
    <main>
        <div class="formulario">  
             <h2>Cadastro de paciente</h2>     
                <label for="numero">Número de Telefone</label>
                <br>
                <input type="text" name="numero" id="numero">
                <br>

                <label for="nome">Nome Completo</label>
                <br>
                <input type="text" name="nome" id="nome">
                <br>
               
               <label for="idade">Idade</label>
               <br>
               <input type="text" name="idade" id="idade">
               <br>
               
               <label for="dataCadastro">Data de Cadastro</label>
               <br>
               <input type="date" name="dataCadastro" id="dataCadastro">
               <br>
               
               <label for="cidade">Cidade</label>
               <br>
               <input type="text" name="cidade" id="cidade">
               
               <br>
               <label for="estado">Estado</label>
               <br>
               <input type="text" name="estado" id="estado">
               <br>
               <button class="botaoCadastrar" id="btnCadastrar">Cadastrar</button>
        </div>
        <aside>
            <nav>
                <a class="botaoCadastro" href="">Cadastro do paciente</a>
                <a class="botaoListagem" href="">Listagem de paciente</a>
            </nav>
        </aside>
        


<section class="listagem">
    <h2>Lista de Pacientes</h2>
    <ul id="listaPacientes"></ul>
</section>

    </main>
    <footer>

        <p>© 2025 Gerencia de Pacientes. Todos os direitos reservados.</p>

    </footer>
<script>


let modoEdicao = false; // Flag booleana que indica se o formulário está no modo de edição ('true') ou cadastro ('false').
  
let pacienteEditandoId = null; // Armazena o _id do paciente que está sendo editado. É 'null' quando o formulário está no modo de cadastro.
  


  const apiUrl = 'http://localhost:3000/paciente'; // Define a URL base da API RESTful para as operaçãoes com pacientes. 


  document.getElementById('btnCadastrar').addEventListener('click', async () => {
  const paciente = {
    numero: document.getElementById('numero').value,
    nome: document.getElementById('nome').value,
    idade: parseInt(document.getElementById('idade').value),
    dataCadastro: document.getElementById('dataCadastro').value,
    cidade: document.getElementById('cidade').value,
    estado: document.getElementById('estado').value,
  }; // Lida com o evento de clique no botão "Cadastrar"(ou "Atualizar").

    // Comportamento:

    // 1: Coleta os valores dos campos do formulário.

    // 2: Verifica 'modoEdicao' e 'pacienteEditandoId':

    // Se 'true' e 'pacienteEditando' não for nulo, envia uma requisição 'PATCH' para 'apiUrl/:id' para atualizar o paciente.
    // Caso contrário, envia uma requisição 'POST' para 'apiUrl' para cadastrar um novo paciente.

    // 3: Exibe alertas de sucesso ou erro ('alert()')

    // 4: Chama 'limparFormulario()' para resetar o formulário.

    // 5: Chama 'listarPacientes()' atualizar a lista exibida. 
    

  try {
    let response;

    if (modoEdicao && pacienteEditandoId) {
      // PATCH
      response = await fetch(`${apiUrl}/${pacienteEditandoId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(paciente)
      });
    } else {
      // POST
      response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(paciente)
      });
    }

    if (response.ok) {
      alert(modoEdicao ? 'Paciente atualizado!' : 'Paciente cadastrado!');
      limparFormulario();
      listarPacientes();
    } else {
      alert('Erro ao enviar os dados.');
    }
  } catch (err) {
    alert('Erro de rede: ' + err.message);
  }
});

  async function listarPacientes() { // Busca todos os pacientes da API e os exibe na seção de listagem.

  // Comportamento: 

  // 1: Faz uma requisição 'GET' para 'apiUrl'

  // 2: Processa a resposta JSON

  // 3: Limpa o conteúdo atual da <ul> com 'id="listaPacientes"'.

  // 4: Para cada paciente retornado:
  
  // Cria um elemento <li>

  // Popula o <li> com os dados do paciente(nome, idade, cidade, estado, numero, data de nascimento).

  // Adiciona botões "Editar" e "Excluir" com 'onclick' chamando 'carregarPaciente()' e 'deletarPaciente()' respectivamente, passando o '_id' do paciente.

  // adiciona o <li> à lista.

  // 5: Trata erros de listagem.

    try {
      const response = await fetch(apiUrl);
      const pacientes = await response.json();
      const lista = document.getElementById('listaPacientes');
      lista.innerHTML = '';

      pacientes.forEach(p => {
        const li = document.createElement('li');
        li.innerHTML = `
  <strong>${p.nome}</strong> - ${p.idade} anos - ${p.cidade}/${p.estado}
  <br>📞 ${p.numero ?? 'Não informado'}
  <br>
  <button onclick="carregarPaciente('${p._id}')">Editar</button>
  <button onclick="deletarPaciente('${p._id}')">Excluir</button>
`;

        lista.appendChild(li);
      });
    } catch (err) {
      console.error('Erro ao listar:', err);
    }
  }





  async function carregarPaciente(_id) {
    // Carrega os dados de um paciente específico no formulário para edição

      //Comportamento:

      // 1: Faz uma requisição 'GET' para 'apiUrl/:_id'

      // 2: Preenche os campos do formulário('numero', 'nome', 'idade', 'dataCadastro', 'cidade', 'estado') com os dados do paciente retornado.

      // 3: Altera o texto do botão 'btnCadastrar' para "Atualizar"

      // 4: Define 'modoEdicao = true' e 'pacienteEditando = _ id'.

      // 5: Importante: Reatribui o 'onclick' do botão 'btnCadastrar' para chamar 'atualizarPaciente(_id)'.

    try {
      const response = await fetch(`${apiUrl}/${_id}`);
      const p = await response.json();

      // Preenche os campos do formulário
      document.getElementById('numero').value = p.numero;
      document.getElementById('nome').value = p.nome;
      document.getElementById('idade').value = p.idade;
      document.getElementById('dataCadastro').value = p.dataCadastro.substring(0, 10);
      document.getElementById('cidade').value = p.cidade;
      document.getElementById('estado').value = p.estado;

      // Substitui o botão de cadastro por botão de atualização
      const btn = document.getElementById('btnCadastrar');
      btn.textContent = 'Atualizar';
      modoEdicao = true;
      pacienteEditandoId = _id; 
      // Guarda o ID do paciente que está sendo editado
      // Atualiza o onclick do botão para chamar a função de atualização

      btn.onclick = () => atualizarPaciente(_id);
    } catch (err) {
      alert('Erro ao carregar paciente.');
    }
  }


// Envia os dados atualizados de um paciente para a API.

// Coleta os dados do formulário e envia uma requisição PATCH para apiUrl/:_id. Após o sucesso, limpa o formulário e recarrega a lista.


  async function atualizarPaciente(_id) {
    console.log('Atualizando paciente com ID:', _id);
    const paciente = { // Envia os dados atualizados de um paciente para a API.

      // Compartamento:
      
      // 1: Coleta os dados atuais do formulário. 

      // 2: Envia um requisição 'PATCH' para 'apiUrl/:_id' com os dados atualizados.

      // 3: Exibe alertas de sucesso ou erro.

      // 4: Chama 'limparFormulario()' e 'listarPacientes()' após a atualização bem-sucedida.

      numero: document.getElementById('numero').value,
      nome: document.getElementById('nome').value,
      idade: parseInt(document.getElementById('idade').value),
      dataCadastro: document.getElementById('dataCadastro').value,
      cidade: document.getElementById('cidade').value,
      estado: document.getElementById('estado').value,
    };

    try {
      const response = await fetch(`${apiUrl}/${_id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(paciente)
      });

      if (response.ok) {
        alert('Paciente atualizado!');
        limparFormulario();
        listarPacientes();
      } else {
        alert('Erro ao atualizar!');
      }
    } catch (err) {
      alert('Erro de rede: ' + err.message);
    }
  }


// Remove um paciente do banco de dados

// Solicita confirmação ao usuário e, se confirmada, envia uma requisição DELETE para apiUrl/:_id. Após o sucesso, recarrega a lista.


  async function deletarPaciente(_id) {
    if (!confirm('Deseja realmente excluir este paciente?')) return; // Remove um paciente do banco de dados.

    // Comportamento:

    // 1: Exibe uma caixa de diálogo de confirmação ('confirm()'). Se o usuário cancelar, a função é encerrada.

    // 2: Se confirmado, envia uma requisição 'DELETE' para 'apiUrl/:_id'.

    // 3: Exibe alertas de sucesso ou erro.

    // 4: Chama 'listarPacientes()' após a exclusão bem-sucedida.

    try {
      const response = await fetch(`${apiUrl}/${_id}`, {
        method: 'DELETE',
      });

      if (response.ok) {
        alert('Paciente excluído!');
        listarPacientes();
      } else {
        alert('Erro ao excluir!');
      }
    } catch (err) {
      alert('Erro de rede: ' + err.message);
    }
  }

// Limpa todos os campos do formulário e restaura o botão btnCadastrar para seu estado original de "Cadastrar".


  function limparFormulario() { // Limpa todos os campos do formulário e restaura o botão 'btnCadastrar' para seu estado original de "Cadastrar".

  // Comportamento: 

  // 1: Define o 'value' de todos os campos de entrada como uma string vazia.

  // 2: Define o 'textContent' do botão 'btnCadastrar'  de volta para "Cadastrar".

  // 3: Reseta 'modoEdicao = false' e 'pacienteEditandoId = null'.

    document.getElementById('numero').value = '';
    document.getElementById('nome').value = '';
    document.getElementById('idade').value = '';
    document.getElementById('dataCadastro').value = '';
    document.getElementById('cidade').value = '';
    document.getElementById('estado').value = '';

    const btn = document.getElementById('btnCadastrar');
    btn.textContent = 'Cadastrar';
  modoEdicao = false;
  pacienteEditandoId = null;
  }

  // Guardar função original para restaurar

  const cadastrarOriginal = document.getElementById('btnCadastrar').onclick;


  // Listar pacientes ao carregar a página

  window.onload = listarPacientes; // Garante que a função 'listaPacientes()' seja executada automaticamente assim que a pagina é completamente carregada no navegador, populando a lista inicial de pacientes.
  
</script>

</body>
</html>